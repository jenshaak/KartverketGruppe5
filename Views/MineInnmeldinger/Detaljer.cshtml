@using KartverketGruppe5.Models
@model InnmeldingModel
@{
    ViewData["Title"] = "Innmelding Detaljer";
    var lokasjon = ViewBag.Lokasjon as LokasjonModel;
}

<div class="flex flex-col gap-4 bg-green-200 p-8 w-full">
    <div class="mb-6">
        <a asp-action="Index" class="text-blue-600 hover:underline">← Tilbake til mine innmeldinger</a>
        <h1 class="text-3xl font-bold mt-4">Innmelding Detaljer</h1>
    </div>
    <div class="flex justify-between items-center w-full rounded-lg bg-white p-2 px-4">
        <div>@Model.KommuneNavn</div>
        <div>@Model.OpprettetDato.ToShortDateString()</div>
        <div class="flex items-center justify-center px-3 py-1 rounded-full @Model.StatusClass">@Model.Status</div>
    </div>
    <form asp-action="EndreInnmelding" 
          method="post" 
          enctype="multipart/form-data" 
          class="flex flex-col gap-4">
        <input type="hidden" asp-for="InnmeldingId" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8" style="min-height: 400px;" >
            <div class="bg-white rounded-lg shadow p-6 flex gap-2">
                <div class="w-2/3 flex flex-col gap-4">
                    <p class="font-medium">Beskrivelse:</p>
                    <textarea asp-for="Beskrivelse" class="w-full h-auto bg-slate-100 rounded-md p-2">@Model.Beskrivelse</textarea>
                </div>
                <div class="w-1/3 flex flex-col gap-4">
                    <p class="font-medium">Bilde:</p>
                    @if (!string.IsNullOrEmpty(Model.BildeSti))
                    {
                        <img id="eksisterendeBilde" 
                             src="@Url.Content("~/" + Model.BildeSti.TrimStart('/'))" 
                             alt="Innmelding-bilde" 
                             class="w-full h-auto rounded-md">
                        <div class="flex gap-2">
                            <div class="flex flex-col gap-2">
                                <input type="file" 
                                    asp-for="Bilde"
                                    id="bilde" 
                                    name="bilde" 
                                    accept="image/*" 
                                    capture="environment" 
                                    class="hidden" 
                                    onchange="visForhandsvisning(this)" />
                                <label for="bilde" class="btn btn-blue cursor-pointer inline-block text-center">
                                    Erstatt bildet
                                </label>
                            </div>
                            <button type="button" onclick="fjernBilde(event)" class="btn btn-red">Fjern bildet</button>
                        </div>
                    }
                    else
                    {
                        <div id="bildeSeksjon" class="flex flex-col gap-2">
                            <input type="file" 
                                asp-for="Bilde"
                                id="bilde" 
                                name="bilde" 
                                accept="image/*" 
                                capture="environment" 
                                class="hidden" 
                                onchange="visForhandsvisning(this)" />
                            <label for="bilde" class="btn btn-blue cursor-pointer inline-block text-center">
                                Legg til bilde
                            </label>
                            <div id="bildeForhandsvisning" class="mt-2" style="display: none;">
                                <img id="forhandsvisningImg" class="w-full h-auto rounded-lg" />
                            </div>
                        </div>
                    }
                </div>  
            </div>  
            <div class="rounded-lg shadow">
                <div id="map" class="w-full h-full rounded-lg"></div>
                <input type="hidden" name="geoJsonInput" id="geoJsonInput" />
                <input type="hidden" name="geometriType" id="geometriType" />
                <input type="hidden" name="latitude" id="latitude" />
                <input type="hidden" name="longitude" id="longitude" />
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Endre innmelding</button>
    </form>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var map = L.map('map');
            var drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Legg til draw control
            var drawControl = new L.Control.Draw({
                draw: {
                    polygon: true,
                    polyline: true,
                    marker: true,
                    circle: false,
                    rectangle: true
                },
                edit: {
                    featureGroup: drawnItems
                }
            });
            map.addControl(drawControl);

            @if (lokasjon != null)
            {
                <text>
                // Sett kartvisning til eksisterende lokasjon
                map.setView([@lokasjon.Latitude, @lokasjon.Longitude], 15);

                @if (!string.IsNullOrEmpty(lokasjon.GeoJson))
                {
                    <text>
                    // Legg til eksisterende GeoJSON
                    var existingGeoJson = @Html.Raw(lokasjon.GeoJson);
                    var existingLayer = L.geoJSON(existingGeoJson, {
                        style: function(feature) {
                            return {
                                color: "#ff7800",
                                weight: 3,
                                opacity: 0.65
                            };
                        }
                    }).addTo(drawnItems);
                    
                    // Bind popup med beskrivelse
                    existingLayer.bindPopup('@Model.Beskrivelse').openPopup();
                    
                    // Zoom til eksisterende feature
                    map.fitBounds(existingLayer.getBounds());
                    </text>
                }
                else
                {
                    <text>
                    // Legg til markør hvis ingen GeoJSON
                    var marker = L.marker([@lokasjon.Latitude, @lokasjon.Longitude]).addTo(drawnItems);
                    marker.bindPopup('@Model.Beskrivelse').openPopup();
                    </text>
                }
                </text>
            }

            // Håndter nye tegninger
            map.on(L.Draw.Event.CREATED, function (e) {
                var type = e.layerType,
                    layer = e.layer;

                // Fjern eksisterende features
                drawnItems.clearLayers();
                
                // Legg til ny feature
                drawnItems.addLayer(layer);

                var geoJsonData = layer.toGeoJSON();
                var geoJsonString = JSON.stringify(geoJsonData);
                
                // Oppdater skjulte felt
                document.getElementById('geoJsonInput').value = geoJsonString;
                document.getElementById('geometriType').value = type;

                // Håndter ulike geometrityper
                switch (type) {
                    case 'marker':
                        var lat = layer.getLatLng().lat;
                        var lng = layer.getLatLng().lng;
                        document.getElementById('latitude').value = lat;
                        document.getElementById('longitude').value = lng;
                        break;
                    case 'polygon':
                    case 'polyline':
                    case 'rectangle':
                        var centerPoint = layer.getBounds().getCenter();
                        document.getElementById('latitude').value = centerPoint.lat;
                        document.getElementById('longitude').value = centerPoint.lng;
                        break;
                }

                // Bind popup med GeoJSON info
                var popupContent = `
                    <strong>Type:</strong> ${type}<br>
                    <strong>GeoJSON:</strong><br>
                    <pre style="max-height: 100px; overflow: auto;">${JSON.stringify(geoJsonData, null, 2)}</pre>
                `;
                layer.bindPopup(popupContent).openPopup();
            });

            // Håndter klikk på kartet
            map.on('click', function (e) {
                var lat = e.latlng.lat;
                var lng = e.latlng.lng;

                // Fjern eksisterende features
                drawnItems.clearLayers();

                // Oppdater skjulte felt
                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lng;
                document.getElementById('geometriType').value = 'Point';

                var marker = L.marker([lat, lng]).addTo(drawnItems);

                var geoJsonPoint = {
                    "type": "Feature",
                    "geometry": {
                        "type": "Point",
                        "coordinates": [lng, lat]
                    },
                    "properties": {
                        "description": "Oppdatert lokasjon"
                    }
                };
                var geoJsonString = JSON.stringify(geoJsonPoint);
                document.getElementById('geoJsonInput').value = geoJsonString;

                marker.bindPopup("Ny lokasjon valgt").openPopup();
            });
        });
        function visForhandsvisning(input) {
            var eksisterendeBilde = document.getElementById('eksisterendeBilde');
            
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                
                reader.onload = function(e) {
                    if (eksisterendeBilde) {
                        // Oppdater eksisterende bilde
                        eksisterendeBilde.src = e.target.result;
                    } else {
                        // Vis forhåndsvisning
                        var forhandsvisningDiv = document.getElementById('bildeForhandsvisning');
                        var forhandsvisningImg = document.getElementById('forhandsvisningImg');
                        forhandsvisningImg.src = e.target.result;
                        forhandsvisningDiv.style.display = 'block';
                    }
                }
                
                reader.readAsDataURL(input.files[0]);
            }
        }

        function fjernBilde(event) {
            event.preventDefault(); // Forhindre form submit
            
            // Finn bilde-seksjonen
            var bildeSeksjon = document.querySelector('.w-1/3');
            
            // Oppdater innholdet med nøyaktig samme struktur som i else-statementet
            bildeSeksjon.innerHTML = `
                <p class="font-medium">Bilde:</p>
                <div id="bildeSeksjon" class="flex flex-col gap-2">
                    <input type="file" 
                        id="bilde" 
                        name="bilde" 
                        accept="image/*" 
                        capture="environment" 
                        class="hidden" 
                        onchange="visForhandsvisning(this)" />
                    <label for="bilde" class="btn btn-blue cursor-pointer inline-block text-center">
                        Legg til bilde
                    </label>
                    <div id="bildeForhandsvisning" class="mt-2" style="display: none;">
                        <img id="forhandsvisningImg" class="w-full h-auto rounded-lg" />
                    </div>
                </div>
            `;
            
            // Legg til skjult felt for å indikere at bildet skal fjernes
            var form = document.querySelector('form');
            var fjernBildeInput = document.createElement('input');
            fjernBildeInput.type = 'hidden';
            fjernBildeInput.name = 'fjernBilde';
            fjernBildeInput.value = 'true';
            form.appendChild(fjernBildeInput);
        }
    </script>
} 