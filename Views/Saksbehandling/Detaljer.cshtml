@model KartverketGruppe5.Models.InnmeldingModel
@{
    ViewData["Title"] = "Innmelding Detaljer";
    var lokasjon = ViewBag.Lokasjon as LokasjonModel;
    var saksbehandlere = ViewBag.Saksbehandlere as List<Saksbehandler>;
    var saksbehandlerId = Context.Session.GetInt32("SaksbehandlerId");
    var isAdmin = Context.Session.GetString("IsAdmin") == "True";
}

<div class="flex flex-col bg-bg w-full items-center p-12">
        <div class="w-4/5 flex flex-col gap-4">
        <h1 class="text-3xl font-bold mt-4 text-center">Behandling av innmeldingen</h1>
        <a asp-action="Index" class="btn btn-primary mb-4">
            <i class="ph ph-arrow-left ph-lg"></i>
            Tilbake
        </a>
    <div class="flex justify-between items-center w-full rounded-lg bg-white px-6 py-4">
        <div>@Model.KommuneNavn</div>
        <div>@Model.OpprettetDato.ToShortDateString()</div>
        <div class="flex items-center justify-center px-3 py-1 rounded-full @Model.StatusClass">@Model.Status</div>
    </div>
    <div class="w-full grid grid-cols-1 md:grid-cols-2 gap-8 mt-4" style="min-height: 400px;" >
        <div class="bg-white rounded-lg shadow p-6 flex gap-4">
            <div class="w-2/3 flex flex-col gap-4">
                <p class="font-medium">Beskrivelse:</p>
                <div class="w-full h-full bg-slate-100 rounded-md p-2">@Model.Beskrivelse</div>
            </div>
            <div class="w-1/3 flex flex-col gap-4">
                <p class="font-medium">Bilde:</p>
                @if (!string.IsNullOrEmpty(Model.BildeSti))
                {
                    <img id="eksisterendeBilde" 
                    src="@Url.Content("~/" + Model.BildeSti.TrimStart('/'))" 
                    alt="Innmelding-bilde" 
                        class="w-full h-auto rounded-md">
                } else {
                    <p>Ingen bilde vedlagt</p>
                }
            </div>  
        </div>  
        <div id="map" class="w-full h-full rounded-lg"></div>
    </div>
        <!-- Handlinger -->
        <div class="mt-12 flex justify-between items-center w-full rounded-lg bg-white p-4">
            @if (Model.SaksbehandlerId == null || Model.SaksbehandlerId == saksbehandlerId || isAdmin) {
                <form asp-action="Videresend" method="post" class="flex border border-slate-300 rounded-lg">
                    <input type="hidden" asp-for="InnmeldingId" />
                    <select name="saksbehandlerId" class="rounded-l-lg p-2 focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Velg saksbehandler</option>
                        @foreach (var saksbehandler in ViewBag.Saksbehandlere)
                        {
                            <option value="@saksbehandler.SaksbehandlerId">
                                @($"{saksbehandler.Fornavn} {saksbehandler.Etternavn}")
                            </option>
                        }
                    </select>
                    <button type="submit" class="bg-blue-500 rounded-r-lg text-white p-2">
                        Gjør ansvarlig
                    </button>
                </form>
                @if (Model.SaksbehandlerId != saksbehandlerId && !isAdmin) {
                    <form asp-action="Behandle" method="post">
                        <input type="hidden" name="id" value="@Model.InnmeldingId" />
                        <button type="submit" class="btn btn-primary">
                        Ta over saken
                        </button>
                    </form>
                } else if (!isAdmin) {
                    <p>Ansvarlig saksbehandler: Deg (@Model.SaksbehandlerNavn)</p>
                } else {
                    @if (Model.SaksbehandlerId == null)
                    {
                        <p>Ingen saksbehandler har tatt saken ennå</p>
                    }
                    else
                    {
                        <p>Ansvarlig saksbehandler: @Model.SaksbehandlerNavn</p>
                    }
                }
            } else {
                <p>Ansvarlig saksbehandler: @Model.SaksbehandlerNavn</p>
            }
        </div>
    </div>
</div>



@section Scripts {
    <script>
        console.log('Lokasjon:', @Json.Serialize(lokasjon));
    </script>
    <script>
        // Vent til dokumentet er lastet
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser kartet
            var map = L.map('map');

            // Legg til kartlaget
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            @if (lokasjon != null)
            {
                <text>
                // Sett kartvisning til lokasjonens koordinater
                map.setView([@lokasjon.Latitude, @lokasjon.Longitude], 15);

                // Legg til markør
                var marker = L.marker([@lokasjon.Latitude, @lokasjon.Longitude]).addTo(map);
                marker.bindPopup('@Model.Beskrivelse').openPopup();

                @if (!string.IsNullOrEmpty(lokasjon.GeoJson))
                {
                    <text>
                    // Legg til GeoJSON hvis det finnes
                    var geoJsonLayer = L.geoJSON(@Html.Raw(lokasjon.GeoJson), {
                        style: function(feature) {
                            return {
                                color: "#ff7800",
                                weight: 3,
                                opacity: 0.65
                            };
                        }
                    }).addTo(map);
                    map.fitBounds(geoJsonLayer.getBounds());
                    </text>
                }
                </text>
            }
        });
    </script>
} 