@model KartverketGruppe5.Models.InnmeldingModel
@{
    ViewData["Title"] = "Innmelding Detaljer";
    var lokasjon = ViewBag.Lokasjon as LokasjonModel;
    var saksbehandlere = ViewBag.Saksbehandlere as List<Saksbehandler>;
    var saksbehandlerId = Context.Session.GetInt32("SaksbehandlerId");
    var isAdmin = Context.Session.GetString("IsAdmin") == "True";
}

<div class="flex flex-col bg-bg w-full p-12">
        <a asp-action="Index" class="text-blue-600 hover:text-blue-800">
            ← Tilbake til oversikt
        </a>
    <h1 class="text-2xl font-bold mb-6">Innmelding Detaljer</h1>

    <div class="flex justify-between items-center w-full bg-white rounded-lg p-4">
        <div class="font-medium text-gray-900">@Model.KommuneNavn</div>
        <div class="text-sm text-gray-500">@Model.OpprettetDato.ToShortDateString()</div>
        <div class="flex items-center gap-2">
            <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full @Model.StatusClass">
                @Model.Status
            </span>
        </div>
    </div>
                      
    <div class="flex justify-center items-center gap-4">
            <div class="text-sm text-gray-500 w-full h-full bg-white rounded-md p-4">@Model.Beskrivelse</div>
            <div id="map" style="height: 400px; width: 100%;" class="rounded-md"></div>
        </div>
        <!-- Handlinger -->
        <div class="mt-8 flex justify-evenly w-full">
            @if (Model.SaksbehandlerId == null || Model.SaksbehandlerId == saksbehandlerId || isAdmin) {
                <form asp-action="Videresend" method="post" class="flex flex-col gap-4">
                    <input type="hidden" asp-for="InnmeldingId" />
                    <select name="saksbehandlerId" class="rounded-lg p-2 border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Velg saksbehandler</option>
                        @foreach (var saksbehandler in ViewBag.Saksbehandlere)
                        {
                            <option value="@saksbehandler.SaksbehandlerId">
                                @($"{saksbehandler.Fornavn} {saksbehandler.Etternavn}")
                            </option>
                        }
                    </select>
                    <button type="submit" class="btn btn-blue">
                        Gjør ansvarlig
                    </button>
                </form>
                @if (Model.SaksbehandlerId != saksbehandlerId && !isAdmin) {
                    <form asp-action="Behandle" method="post">
                        <input type="hidden" name="id" value="@Model.InnmeldingId" />
                        <button type="submit" class="btn btn-primary">
                        Ta over saken
                        </button>
                    </form>
                } else if (!isAdmin) {
                    <p>Ansvarlig saksbehandler: Deg (@Model.SaksbehandlerNavn)</p>
                } else {
                    <p>Ansvarlig saksbehandler: @Model.SaksbehandlerNavn</p>
                }
            } else {
                <p>Ansvarlig saksbehandler: @Model.SaksbehandlerNavn</p>
            }
        </div>
</div>



@section Scripts {
    <script>
        console.log('Lokasjon:', @Json.Serialize(lokasjon));
    </script>
    <script>
        // Vent til dokumentet er lastet
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser kartet
            var map = L.map('map');

            // Legg til kartlaget
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            @if (lokasjon != null)
            {
                <text>
                // Sett kartvisning til lokasjonens koordinater
                map.setView([@lokasjon.Latitude, @lokasjon.Longitude], 15);

                // Legg til markør
                var marker = L.marker([@lokasjon.Latitude, @lokasjon.Longitude]).addTo(map);
                marker.bindPopup('@Model.Beskrivelse').openPopup();

                @if (!string.IsNullOrEmpty(lokasjon.GeoJson))
                {
                    <text>
                    // Legg til GeoJSON hvis det finnes
                    var geoJsonLayer = L.geoJSON(@Html.Raw(lokasjon.GeoJson), {
                        style: function(feature) {
                            return {
                                color: "#ff7800",
                                weight: 3,
                                opacity: 0.65
                            };
                        }
                    }).addTo(map);
                    map.fitBounds(geoJsonLayer.getBounds());
                    </text>
                }
                </text>
            }
        });
    </script>
} 