@model PagedResult<KartverketGruppe5.Models.InnmeldingModel>
@using KartverketGruppe5.Models
@{
    ViewData["Title"] = "Saksbehandling";
    var statuses = (List<string>)ViewData["Statuses"];
    var fylker = ViewBag.Fylker as List<Fylke> ?? new List<Fylke>();
}

<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">Behandle Innmeldinger</h1>

    <!-- Filters -->
    <div class="mb-6 flex gap-4">
        <div class="w-64">
            <label for="statusFilter" class="block text-sm font-medium text-gray-700">Status</label>
            <select id="statusFilter" 
                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                <option value="">Alle statuser</option>
                @if(statuses != null)
                {
                    @foreach (var status in statuses)
                    {
                    <option value="@status" selected="@(status == ViewData["CurrentStatus"]?.ToString())">
                        @status
                        </option>
                    }
                }
            </select>
        </div>
        <div class="w-64">
            <label for="fylkeFilter" class="block text-sm font-medium text-gray-700">Fylke</label>
            <select id="fylkeFilter" name="fylkeFilter"
                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                <option value="">Alle fylker</option>
                @foreach (var fylke in ViewBag.Fylker)
                {
                    <option value="@fylke.Navn" selected="@(fylke.Navn == ViewData["CurrentFylke"]?.ToString())">
                        @fylke.Navn
                    </option>
                }
            </select>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fylke</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kommune</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <a asp-action="Index" 
                           asp-route-sortOrder="@ViewData["DateSortParam"]"
                           class="text-gray-500 hover:text-gray-700">
                            Dato
                            @if (ViewData["CurrentSort"].ToString().StartsWith("date"))
                            {
                                <span class="ml-1">
                                    @(ViewData["CurrentSort"].ToString() == "date_desc" ? "↓" : "↑")
                                </span>
                            }
                        </a>
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Status
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Handling
                    </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var innmelding in Model.Items)
                {
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="font-medium text-gray-900">@innmelding.FylkeNavn</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="font-medium text-gray-900">@innmelding.KommuneNavn</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">@innmelding.OpprettetDato.ToShortDateString()</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center gap-2">
                                <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full @innmelding.StatusClass">
                                    @innmelding.Status
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <a asp-action="Detaljer" 
                               asp-route-id="@innmelding.InnmeldingId" 
                               class="text-blue-600 hover:text-blue-900 font-medium hover:underline">
                                Se detaljer
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="mt-4 flex justify-center">
        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
            @if (Model.HasPreviousPage)
            {
                <a asp-action="Index" 
                   asp-route-page="@(Model.CurrentPage - 1)"
                   asp-route-sortOrder="@ViewData["CurrentSort"]"
                   class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                    <span class="sr-only">Forrige</span>
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                </a>
            }

            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                <a asp-action="Index"
                   asp-route-page="@i"
                   asp-route-sortOrder="@ViewData["CurrentSort"]"
                   class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium @(i == Model.CurrentPage ? "text-blue-600 bg-blue-50" : "text-gray-700 hover:bg-gray-50")">
                    @i
                </a>
            }

            @if (Model.HasNextPage)
            {
                <a asp-action="Index"
                   asp-route-page="@(Model.CurrentPage + 1)"
                   asp-route-sortOrder="@ViewData["CurrentSort"]"
                   class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                    <span class="sr-only">Neste</span>
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                </a>
            }
        </nav>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            function updateFilters() {
                var status = $('#statusFilter').val();
                var fylke = $('#fylkeFilter').val();
                var currentSort = '@ViewData["CurrentSort"]';
                var currentPage = '@Model.CurrentPage';

                var params = new URLSearchParams();
                
                if (status) params.append('statusFilter', status);
                if (fylke) params.append('fylkeFilter', fylke);
                if (currentSort) params.append('sortOrder', currentSort);
                if (currentPage) params.append('page', currentPage);

                window.location.href = '@Url.Action("Index")' + '?' + params.toString();
            }

            // Event listeners
            $('#statusFilter, #fylkeFilter').on('change', function() {
                updateFilters();
            });
        });
    </script>
}